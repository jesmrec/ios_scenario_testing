name: Tests

on:
  workflow_call:
    inputs:
      artifact_app:
        description: 'Name of the .app artifact to test'
        type: string
    secrets:
      OC_SERVER_URL:
        required: true  

jobs:
  tests:
    name: launch_tests
    runs-on: macos-15

    steps:
      # Checkout repo 
      - name: Checkout repo
        uses: actions/checkout@v4

      # Download artifacts
      - name: Download app artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_app }}
          path: ./src/test/resources 

      # List folders
      - name: List stuff
        run: |
          rm -rf ./src/test/resources/ownCloud.app
          ls -al .
          ls -al ./src/test/resources
          xcrun simctl list devices

      # Unzip the app
      - name: Unzip app artifact
        run: |
          APP_ZIP="./src/test/resources/${{ inputs.artifact_app }}"
          TARGET_DIR="./src/test/resources/"
          
          echo "Unzipping $APP_ZIP to $TARGET_DIR"
          unzip -q "$APP_ZIP" -d "$TARGET_DIR"
          
          echo "Unzipped content:"
          ls -R "$TARGET_DIR"/ownCloud.app
          rm -rf ./src/test/resources/ownCloud.app.zip
          ls -al ./src/test/resources

      # Verify the .app folder exists
      - name: Verify .app exists
        run: |
          if [ ! -d "./src/test/resources/ownCloud.app" ]; then
            echo "âŒ .app not found after unzip!"
            exit 1
          fi
          echo "âœ… .app found and ready for testing"

      # Launch simulator
      - name: Start iOS Simulator
        run: |
          echo "Creating and booting iOS Simulator..."

          DEVICE="${{ vars.DEFAULT_DEVICE }}"
          OS_VERSION="${{ vars.DEFAULT_OS }}"

          # Find the UDID of the desired simulator
          UDID=$(xcrun simctl list devices "$OS_VERSION" \
            | grep -E "^\s*$DEVICE \(" \
            | head -n 1 \
            | awk -F '[()]' '{print $2}')

          if [ -z "$UDID" ]; then
            echo "âŒ Simulator not found: $DEVICE ($OS_VERSION)"
            exit 1
          fi

          # Check if the simulator is already booted
          STATE=$(xcrun simctl list devices | grep "$UDID" | awk -F'[()]' '{print $4}')

          if [ "$STATE" = "Booted" ]; then
            echo "âœ… Simulator '$DEVICE' ($OS_VERSION) is already running (UDID: $UDID)."
          else
            echo "ðŸš€ Booting simulator '$DEVICE' ($OS_VERSION)..."
            xcrun simctl boot "$UDID"
            xcrun simctl bootstatus "$UDID" -b
            echo "UDID_DEVICE=$UDID" >> $GITHUB_ENV
            echo "âœ… Simulator is now ready."
          fi

          # Optionally, print the booted simulator list for debugging
          xcrun simctl list devices | grep Booted

      # Set up enviroment
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Start Appium
        run: |
          mkdir -p logs video
          chmod +x ./runAppium.sh
          ./runAppium.sh

      # Launch tests
      - name: Launch tests
        env:
          OC_SERVER_URL: ${{ secrets.OC_SERVER_URL }}
          BACKEND: "oCIS"
        run: |
          ./executeTests -t @createfolder
