name: Tests

on:
  workflow_call:
    inputs:
      artifact_app:
        description: 'Name of the .app artifact to test'
        type: string
        required: true
      wda:
        description: 'Name of WDA artifact'
        type: string
        required: true
    secrets:
      OC_SERVER_URL:
        required: true  

jobs:
  tests:
    name: launch_tests
    runs-on: macos-15

    env:
        DEVICE: ${{ vars.DEFAULT_DEVICE }}
        OS: ${{ vars.DEFAULT_OS }}

    steps:
      # Checkout repo 
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Select Xcode version
        env:
          XCODE_VERSION: ${{ vars.DEFAULT_XCODE }}
        run: |
          echo "Selecting Xcode version $XCODE_VERSION"
          sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          xcodebuild -version

      # Download artifacts
      - name: Download app artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_app }}
          path: ./src/test/resources 

      - name: Download WebDriverAgent artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.wda }}
          path: ./

      # List folders
      - name: List stuff
        run: |
          rm -rf ./src/test/resources/ownCloud.app
          ls -al .
          ls -al ./src/test/resources
          xcrun simctl list devices

      # Unzip the app
      - name: Unzip app artifact
        run: |
          APP_ZIP="./src/test/resources/${{ inputs.artifact_app }}"
          TARGET_DIR="./src/test/resources/"
          
          echo "Unzipping $APP_ZIP to $TARGET_DIR"
          unzip -q "$APP_ZIP" -d "$TARGET_DIR"
          
          echo "Unzipped content:"
          ls -R "$TARGET_DIR"/ownCloud.app
          rm -rf ./src/test/resources/ownCloud.app.zip
          ls -al ./src/test/resources

      # Verify the .app folder exists
      - name: Verify .app exists
        run: |
          if [ ! -d "./src/test/resources/ownCloud.app" ]; then
            echo "âŒ .app not found after unzip!"
            exit 1
          fi
          echo "âœ… .app found and ready for testing"

      - name: Start Appium
        run: |
          mkdir -p logs video
          chmod +x ./runAppium.sh
          ./runAppium.sh

      # Launch simulator
      - name: Start iOS Simulator
        run: |
          echo "Creating and booting iOS Simulator..."

          DEVICE="${{ vars.DEFAULT_DEVICE }}"
          #OS_VERSION="${{ vars.DEFAULT_OS }}"

          # Find the UDID of the desired simulator
          UDID=$(xcrun simctl list devices "iOS $OS" \
            | grep -E "^\s*$DEVICE \(" \
            | head -n 1 \
            | awk -F '[()]' '{print $2}')

          if [ -z "$UDID" ]; then
            echo "âŒ Simulator not found: $DEVICE ($OS)"
            exit 1
          fi

          # Check if the simulator is already booted
          STATE=$(xcrun simctl list devices | grep "$UDID" | awk -F'[()]' '{print $4}')

          # Export UDID always
          echo "UDID=$UDID" >> $GITHUB_ENV

          if [ "$STATE" = "Booted" ]; then
            echo "âœ… Simulator '$DEVICE' ($OS) is already running (UDID: $UDID)."
          else
            echo "ðŸš€ Booting simulator '$DEVICE' ($OS)..."
            xcrun simctl boot "$UDID"
            xcrun simctl bootstatus "$UDID" -b
            echo "âœ… Simulator is now ready."
          fi

          # Optionally, print the booted simulator list for debugging
          xcrun simctl list devices | grep Booted

      - name: Unzip WDA
        run: |
          ls -al .
          unzip -q "${{ inputs.wda }}" -d .
          ls -al .

      - name: Install and launch WebDriverAgent on simulator
        run: |
          echo "Searching for WebDriverAgent build inside downloaded artifact..."

          ls -al .

          # Find the precompiled WDA app
          WDA_APP=$(find ./DerivedData -name "WebDriverAgentRunner-Runner.app" -type d | head -n 1)

          if [ -z "$WDA_APP" ]; then
            echo "ERROR: WebDriverAgentRunner-Runner.app not found inside artifact '${{ inputs.wda }}'"
            exit 1
          fi

          echo "WDA app found at: $WDA_APP"

          # Locate the booted simulator
          echo "Resolving booted simulator UDID for $DEVICE (iOS $OS)..."
          SIM_ID="$UDID"

          if [ -z "$SIM_ID" ]; then
            echo "ERROR: UDID is empty, cannot find booted simulator!"
            xcrun simctl list
            exit 1
          fi

          echo "Booted simulator detected: $SIM_ID"

          # Install WebDriverAgent
          echo "Installing WebDriverAgent..."
          xcrun simctl install "$SIM_ID" "$WDA_APP"
          echo "WDA installed successfully"

          # Get bundle ID from WDA app
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$WDA_APP/Info.plist")
          echo "Bundle Identifier: $BUNDLE_ID"

          # Launch WebDriverAgent service
          echo "Launching WebDriverAgent..."
          xcrun simctl launch "$SIM_ID" "$BUNDLE_ID"

          echo "WebDriverAgent is now running on the simulator"

      # Set up enviroment
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Check if Appium is running
        run: |
          set -e

          APP_URL="http://127.0.0.1:4723"
          echo "Checking Appium at $APP_URL"

          #
          # 1) Check if port 4723 is open
          #
          if command -v nc >/dev/null 2>&1; then
            if nc -z 127.0.0.1 4723; then
              echo "Port 4723 is open"
            else
              echo "Port 4723 is not open (Appium may not be listening)"
              exit 1
            fi
          else
            echo "'nc' is not available â€” skipping port check"
          fi


          #
          # 2) Poll /status and /wd/hub/status
          #
          MAX_RETRIES=15
          SLEEP=1
          APP_READY=false

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Checking Appium status (attempt $i/$MAX_RETRIES)..."

            if curl -s "$APP_URL/status" | grep -q '"ready":true'; then
              echo "âœ“ Appium is ready (via /status)"
              APP_READY=true
              break
            fi

            if curl -s "$APP_URL/wd/hub/status" | grep -q '"ready":true'; then
              echo "âœ“ Appium is ready (via /wd/hub/status)"
              APP_READY=true
              break
            fi

            sleep $SLEEP
          done


          #
          # 3) Check if WebDriverAgent is running on the simulator
          #
          echo "Checking if WebDriverAgent is running on simulator $UDID..."

          # Evita el â€œBroken pipeâ€ silenciando stderr
          if xcrun simctl spawn "$UDID" launchctl list 2>/dev/null | grep -q WebDriverAgent; then
            echo "âœ“ WebDriverAgent process is running"
            WDA_STATUS=running
          else
            echo "âœ— WebDriverAgent process NOT listed in launchctl"
            WDA_STATUS=missing
          fi


          #
          # 4) Deep check: verify that the WDA bundle exists in Appium installation
          #
          WDA_DIR="/usr/local/lib/node_modules/appium/node_modules/appium-xcuitest-driver/WebDriverAgent"

          echo "Checking Appium WDA bundle at:"
          echo "  $WDA_DIR"

          if [ -d "$WDA_DIR" ]; then
            echo "âœ“ WDA bundle exists in the Appium installation"
          else
            echo "âœ— WDA bundle is missing in Appium installation"
            echo "  This could cause WDA build/start failures"
          fi


          #
          # 5) If Appium is ready â†’ OK
          #
          if [ "$APP_READY" = true ]; then
            echo "Appium is ready"
            exit 0
          fi


          #
          # 6) Appium NOT ready â†’ show logs and fail
          #
          echo "âœ— Appium did not become ready after $MAX_RETRIES attempts."

          if [ -f appium.log ]; then
            echo "===== Last lines of appium.log ====="
            tail -n 200 appium.log || true
            echo "===================================="
          else
            echo "No appium.log found."
          fi

          exit 1

      # Launch tests
      - name: Launch tests
        env:
          OC_SERVER_URL: ${{ secrets.OC_SERVER_URL }}
          BACKEND: "oCIS"
        run: |
          export UDID_DEVICE="$UDID"
          echo "UDID of sim to execute: $UDID"
          ./executeTests -t @createfolder
